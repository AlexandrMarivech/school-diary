# app.py
from flask import Flask, render_template, request, redirect, url_for, session, make_response, flash, send_file
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
import csv, io, os, datetime
from openpyxl import Workbook
from openpyxl.chart import BarChart, Reference
from openpyxl.utils import get_column_letter
from datetime import datetime

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Flask & DB config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app = Flask(__name__)

BASE_DIR = os.path.abspath(os.path.dirname(__file__))
INSTANCE_DIR = os.path.join(BASE_DIR, "instance")
os.makedirs(INSTANCE_DIR, exist_ok=True)

app.config["SECRET_KEY"] = os.environ.get("SECRET_KEY", "dev-only-CHANGE-ME")
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///" + os.path.join(INSTANCE_DIR, "data.db")
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False

db = SQLAlchemy(app)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Models ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    role = db.Column(db.String(20), nullable=False)  # student / teacher / admin
    fullname = db.Column(db.String(120), nullable=True)

class Subject(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(80), unique=True, nullable=False)

class Grade(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    student_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    subject_id = db.Column(db.Integer, db.ForeignKey('subject.id'), nullable=False)
    value = db.Column(db.Integer, nullable=False)
    year = db.Column(db.Integer, nullable=False)
    quarter = db.Column(db.Integer, nullable=False)
    week = db.Column(db.Integer, nullable=True)  # 1..10 (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def current_year():
    return datetime.date.today().year


# –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å {{ current_year() }} –ø—Ä—è–º–æ –≤ —à–∞–±–ª–æ–Ω–∞—Ö
@app.context_processor
def inject_globals():
    return dict(current_year=current_year, datetime=datetime)



def create_demo_data():
    db.drop_all()
    db.create_all()

    # –ü—Ä–µ–¥–º–µ—Ç—ã
    s1 = Subject(name="–†—É—Å—Å–∫–∏–π")
    s2 = Subject(name="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞")
    s3 = Subject(name="–§–∏–∑–∏–∫–∞")
    db.session.add_all([s1, s2, s3])
    db.session.commit()

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    admin = User(username="admin", password_hash=generate_password_hash("admin123"),
                 role="admin", fullname="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –®–∫–æ–ª—ã")
    teacher = User(username="teacher", password_hash=generate_password_hash("teach123"),
                   role="teacher", fullname="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (–£—á–∏—Ç–µ–ª—å)")

    students = []
    # –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É—á–µ–Ω–∏–∫–æ–≤
    profiles = {
        "–û—Ç–ª–∏—á–Ω–∏–∫": [5, 5, 5, 5],
        "–•–æ—Ä–æ—à–∏—Å—Ç": [4, 4, 5, 4],
        "–°—Ä–µ–¥–Ω—è—á–æ–∫": [3, 4, 3, 4],
        "–¢—Ä–æ–µ—á–Ω–∏–∫": [3, 3, 3, 3],
        "–î–≤–æ–µ—á–Ω–∏–∫": [2, 2, 3, 2],
    }

    # –°–æ–∑–¥–∞–¥–∏–º 30 —É—á–µ–Ω–∏–∫–æ–≤, —Ü–∏–∫–ª–æ–º —Ä–∞–∑–¥–∞–¥–∏–º –∏–º –ø—Ä–æ—Ñ–∏–ª–∏
    for i in range(1, 31):
        if i <= 5:
            prof = "–û—Ç–ª–∏—á–Ω–∏–∫"
        elif i <= 12:
            prof = "–•–æ—Ä–æ—à–∏—Å—Ç"
        elif i <= 22:
            prof = "–°—Ä–µ–¥–Ω—è—á–æ–∫"
        elif i <= 28:
            prof = "–¢—Ä–æ–µ—á–Ω–∏–∫"
        else:
            prof = "–î–≤–æ–µ—á–Ω–∏–∫"

        u = User(
            username=f"student{i}",
            password_hash=generate_password_hash("stud123"),
            role="student",
            fullname=f"–£—á–µ–Ω–∏–∫ {i} ({prof})"
        )
        db.session.add(u)
        students.append((u, profiles[prof]))

    db.session.add_all([admin, teacher])
    db.session.commit()

    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫–∏
    for u, pattern in students:
        for subj in [s1, s2, s3]:
            for q, val in enumerate(pattern, start=1):
                g = Grade(student_id=u.id, subject_id=subj.id, value=val,
                          year=current_year(), quarter=q)
                db.session.add(g)
    db.session.commit()

    print("Demo data created! Users:")
    print("  admin/admin123, teacher/teach123, student1..30/stud123")


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/")
def index():
    if "user_id" in session:
        return redirect(url_for("dashboard"))
    return redirect(url_for("login"))

@app.route("/login", methods=["GET", "POST"])
def login():
    error = ""
    if request.method == "POST":
        username = request.form["username"].strip()
        password = request.form["password"].strip()
        user = User.query.filter_by(username=username).first()
        if user and check_password_hash(user.password_hash, password):
            session["user_id"] = user.id
            session["role"] = user.role
            session["username"] = user.username
            session["fullname"] = user.fullname
            flash("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "success")
            return redirect(url_for("dashboard"))
        error = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
        flash(error, "danger")
    return render_template("login.html", error=error)

@app.route("/logout")
def logout():
    session.clear()
    flash("–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "info")
    return redirect(url_for("login"))

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/dashboard")
def dashboard():
    if "user_id" not in session:
        flash("–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥", "danger")
        return redirect(url_for("login"))

    role = session.get("role")

    news = [
    {"title": "–ó–∞–ø—É—â–µ–Ω–∞ –æ–ª–∏–º–ø–∏–∞–¥–∞", "desc": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.",
     "url": "https://www.gov.kz/memleket/entities/edu?lang=ru",
     "image": "https://picsum.photos/400/200?random=1",
     "badge": {"text": "üî• –ì–æ—Ä—è—á–µ–µ", "class": "hot"}},
    {"title": "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞", "desc": "–î–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç—á—ë—Ç—ã –∏ –≤—ã–≥—Ä—É–∑–∫–∞ –≤ Excel.",
     "url": "https://github.com/AlexandrMarivech/school-diary",
     "image": "https://picsum.photos/400/200?random=2",
     "badge": {"text": "üí° –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ", "class": "tip"}},
    {"title": "–ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã", "desc": "–†–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–∏–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –¥–ª—è —à–∫–æ–ª.",
     "url": "https://bilimland.kz/ru/news-articles",
     "image": "https://picsum.photos/400/200?random=3",
     "badge": {"text": "üÜï –ù–æ–≤–æ–µ", "class": "new"}},
]



    return render_template("dashboard.html", role=role, news=news)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Student ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/student")
def student_page():
    if "user_id" not in session or session.get("role") != "student":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", "danger")
        return redirect(url_for("login"))

    student_id = session["user_id"]
    year = int(request.args.get("year", current_year()))

    subjects = Subject.query.all()
    subject_map = {s.id: s.name for s in subjects}

    grades = Grade.query.filter_by(student_id=student_id, year=year).all()

    avg = {}
    for g in grades:
        subjname = subject_map.get(g.subject_id, "")
        avg.setdefault(subjname, []).append(g.value)
    avg = {k: round(sum(v)/len(v), 2) if v else 0 for k, v in avg.items()}

    return render_template("student.html", grades=grades, avg=avg, year=year, subject_map=subject_map)

@app.route("/student/report")
def student_report():
    if "user_id" not in session or session.get("role") != "student":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", "danger")
        return redirect(url_for("login"))

    student_id = session["user_id"]
    year = int(request.args.get("year", current_year()))

    subjects = Subject.query.all()
    subject_map = {s.id: s.name for s in subjects}

    grades = Grade.query.filter_by(student_id=student_id, year=year).all()

    subj_avgs = {}
    for g in grades:
        subjname = subject_map.get(g.subject_id, "")
        subj_avgs.setdefault(subjname, []).append(g.value)
    subj_avgs = {k: round(sum(v)/len(v), 2) if v else 0 for k, v in subj_avgs.items()}
    overall = round(sum([g.value for g in grades])/len(grades), 2) if grades else 0

    return render_template("student_report.html", year=year,
                           subject_avgs=subj_avgs, overall_avg=overall, subjects=subjects)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Teacher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/teacher", methods=["GET", "POST"])
def teacher_page():
    if "user_id" not in session or session.get("role") != "teacher":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π", "danger")
        return redirect(url_for("login"))

    subjects = Subject.query.all()
    students = User.query.filter_by(role="student").all()
    message = ""

    if request.method == "POST":
        subject_id = int(request.form["subject"])
        year = int(request.form["year"])
        quarter = int(request.form["quarter"])
        week = int(request.form.get("week", 1))

        for st in students:
            key = f"student_{st.id}"
            raw = request.form.get(key, "").strip()
            if not raw:
                continue
            try:
                value = int(raw)
            except ValueError:
                continue
            if value < 2 or value > 5:
                continue

            existing = Grade.query.filter_by(
                student_id=st.id, subject_id=subject_id,
                year=year, quarter=quarter, week=week
            ).first()
            if existing:
                existing.value = value
            else:
                db.session.add(Grade(
                    student_id=st.id, subject_id=subject_id, value=value,
                    year=year, quarter=quarter, week=week
                ))
        db.session.commit()
        message = "–û—Ü–µ–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."

    # ‚ö° –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–µ—Ä–µ–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é, –∞ –Ω–µ —á–∏—Å–ª–æ
    return render_template("teacher.html",
                           subjects=subjects, students=students,
                           message=message, current_year=current_year)


# ‚ö° –Ω–æ–≤—ã–π –∞–ª–∏–∞—Å –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫
@app.route("/export/class")
def export_class():
    # –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ export_teacher_xlsx
    return redirect(url_for("export_teacher_xlsx", **request.args))



@app.route("/teacher/report")
def teacher_report():
    if "user_id" not in session or session.get("role") != "teacher":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π", "danger")
        return redirect(url_for("login"))

    subject_id = int(request.args.get("subject", 0))
    year = int(request.args.get("year", current_year()))
    period = request.args.get("period", "year")  # quarter1..4, halfyear1/2, year

    subjects = Subject.query.all()
    students = User.query.filter_by(role="student").all()

    if period.startswith("quarter"):
        quarters = [int(period[-1])]
    elif period == "halfyear1":
        quarters = [1, 2]
    elif period == "halfyear2":
        quarters = [3, 4]
    else:
        quarters = [1, 2, 3, 4]

    report_data = []
    for st in students:
        q = Grade.query.filter_by(student_id=st.id, year=year)
        if subject_id != 0:
            q = q.filter_by(subject_id=subject_id)
        q = q.filter(Grade.quarter.in_(quarters))
        grades = [g.value for g in q.all()]
        avg = round(sum(grades)/len(grades), 2) if grades else 0
        report_data.append((st.fullname or st.username, grades, avg))

    return render_template("teacher_report.html",
                           subjects=subjects, subject_id=subject_id,
                           year=year, period=period, report_data=report_data)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Excel exports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def autosize_columns(ws):
    for col in ws.columns:
        max_len = 0
        col_letter = get_column_letter(col[0].column)
        for cell in col:
            try:
                max_len = max(max_len, len(str(cell.value)) if cell.value else 0)
            except Exception:
                pass
        ws.column_dimensions[col_letter].width = max(12, min(40, max_len + 2))

@app.route("/export/teacher_xlsx")
def export_teacher_xlsx():
    # –£—á–∏—Ç–µ–ª—å/–ê–¥–º–∏–Ω: –≤—ã–≥—Ä—É–∑–∫–∞ –ø–æ –∫–ª–∞—Å—Å—É (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø—Ä–µ–¥–º–µ—Ç/–≥–æ–¥/—á–µ—Ç–≤–µ—Ä—Ç—å/–Ω–µ–¥–µ–ª—è)
    if "user_id" not in session or session.get("role") not in ["teacher", "admin"]:
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π/–∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    subject_id = int(request.args.get("subject", 0))
    year = int(request.args.get("year", current_year()))
    quarter = int(request.args.get("quarter", 0))
    week = int(request.args.get("week", 0))
    subject = Subject.query.get(subject_id) if subject_id != 0 else None
    students = User.query.filter_by(role="student").all()

    wb = Workbook()
    ws = wb.active
    ws.title = "–û—Ç—á–µ—Ç –∫–ª–∞—Å—Å–∞"

    ws.append(["–§–ò–û —É—á–µ–Ω–∏–∫–∞", "–ü—Ä–µ–¥–º–µ—Ç", "–ü–µ—Ä–∏–æ–¥", "–ù–µ–¥–µ–ª—è", "–û—Ü–µ–Ω–∫–∏", "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"])

    for st in students:
        q = Grade.query.filter_by(student_id=st.id, year=year)
        if quarter != 0:
            q = q.filter_by(quarter=quarter)
        if subject_id != 0:
            q = q.filter_by(subject_id=subject_id)
        if week != 0:
            q = q.filter_by(week=week)
        rows = q.all()
        grades = [g.value for g in rows]
        avg = round(sum(grades)/len(grades), 2) if grades else ""
        subjname = subject.name if subject else "–í—Å–µ"
        period_str = f"{year}, Q{quarter if quarter else '1-4'}"
        week_str = week if week else "–≤—Å–µ"
        ws.append([st.fullname or st.username, subjname, period_str, week_str, ";".join(map(str, grades)), avg])

    autosize_columns(ws)

    # –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ —Å—Ä–µ–¥–Ω–∏–º (–∫–æ–ª–æ–Ω–∫–∞ F)
    data_start = 2
    data_end = ws.max_row
    if data_end >= data_start:
        chart = BarChart()
        chart.title = "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ —É—á–µ–Ω–∏–∫–∞–º"
        values = Reference(ws, min_col=6, min_row=1, max_row=data_end)  # F1..F*
        cats = Reference(ws, min_col=1, min_row=2, max_row=data_end)    # A2..A*
        chart.add_data(values, titles_from_data=True)
        chart.set_categories(cats)
        chart.y_axis.title = "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"
        chart.x_axis.title = "–£—á–µ–Ω–∏–∫"
        ws.add_chart(chart, "H2")

    filepath = os.path.join(INSTANCE_DIR, f"teacher_report_{year}_q{quarter}_w{week}.xlsx")
    wb.save(filepath)
    return send_file(filepath, as_attachment=True)


@app.route("/export/student_xlsx")
def export_student_xlsx():
    # –°—Ç—É–¥–µ–Ω—Ç: –ª–∏—á–Ω—ã–π –æ—Ç—á—ë—Ç —Å –¥–∏–∞–≥—Ä–∞–º–º–æ–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
    if "user_id" not in session or session.get("role") != "student":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", "danger")
        return redirect(url_for("login"))

    student_id = session["user_id"]
    year = int(request.args.get("year", current_year()))
    subjects = Subject.query.all()
    subject_map = {s.id: s.name for s in subjects}

    q = Grade.query.filter_by(student_id=student_id, year=year).all()
    subj_avgs = {}
    for g in q:
        name = subject_map.get(g.subject_id, "–ù–µ–∏–∑–≤.")
        subj_avgs.setdefault(name, []).append(g.value)

    wb = Workbook()
    ws = wb.active
    ws.title = f"–û—Ç—á—ë—Ç {year}"

    ws.append(["–ü—Ä–µ–¥–º–µ—Ç", "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"])
    for s in subjects:
        vals = subj_avgs.get(s.name, [])
        avg = round(sum(vals)/len(vals), 2) if vals else 0
        ws.append([s.name, avg])

    autosize_columns(ws)

    # –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
    data_end = ws.max_row
    if data_end >= 2:
        chart = BarChart()
        chart.title = "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º"
        values = Reference(ws, min_col=2, min_row=1, max_row=data_end)
        cats = Reference(ws, min_col=1, min_row=2, max_row=data_end)
        chart.add_data(values, titles_from_data=True)
        chart.set_categories(cats)
        chart.y_axis.title = "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"
        chart.x_axis.title = "–ü—Ä–µ–¥–º–µ—Ç"
        ws.add_chart(chart, "E2")

    filepath = os.path.join(INSTANCE_DIR, f"student_report_{year}.xlsx")
    wb.save(filepath)
    return send_file(filepath, as_attachment=True)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/admin", methods=["GET", "POST"])
def admin_page():
    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    message = ""
    if request.method == "POST":
        username = request.form["username"].strip()
        fullname = request.form.get("fullname", "").strip()
        password = request.form["password"].strip()
        role = request.form["role"]

        if username and password and len(password) > 4 and role in ["student", "teacher", "admin"]:
            if User.query.filter_by(username=username).first():
                message = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                flash(message, "danger")
            else:
                u = User(
                    username=username,
                    password_hash=generate_password_hash(password),
                    role=role,
                    fullname=fullname
                )
                db.session.add(u)
                db.session.commit()
                message = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω"
                flash(message, "success")
        else:
            message = "–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–æ–ª—å >4 —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–æ–ª—å)"
            flash(message, "danger")

    users = User.query.all()
    return render_template("admin.html", users=users, message=message)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/edit_user/<int:user_id>", methods=["POST"])
def edit_user(user_id):
    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    user = User.query.get_or_404(user_id)

    username = request.form.get("username", "").strip()
    fullname = request.form.get("fullname", "").strip()
    role = request.form.get("role", "").strip()
    password = request.form.get("password", "").strip()

    if username:
        user.username = username
    user.fullname = fullname
    if role in ["student", "teacher", "admin"]:
        user.role = role
    if password and len(password) > 4:
        user.password_hash = generate_password_hash(password)

    db.session.commit()
    flash("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω", "success")
    return redirect(url_for("admin_page"))


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin: —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/delete_user/<int:user_id>", methods=["POST"])
def delete_user(user_id):
    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    user = User.query.get_or_404(user_id)

    # –ó–∞—â–∏—Ç–∞ ‚Äî –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if user.role == "admin":
        flash("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!", "danger")
        return redirect(url_for("admin_page"))

    db.session.delete(user)
    db.session.commit()
    flash("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω", "info")
    return redirect(url_for("admin_page"))


    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    message = ""
    if request.method == "POST":
        username = request.form["username"].strip()
        fullname = request.form.get("fullname", "").strip()
        password = request.form["password"].strip()
        role = request.form["role"]
        if username and password and len(password) > 4 and role in ["student", "teacher", "admin"]:
            if User.query.filter_by(username=username).first():
                message = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                flash(message, "danger")
            else:
                u = User(username=username,
                         password_hash=generate_password_hash(password),
                         role=role, fullname=fullname)
                db.session.add(u)
                db.session.commit()
                message = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω"
                flash(message, "success")
        else:
            message = "–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–æ–ª—å >4 —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–æ–ª—å)"
            flash(message, "danger")

    users = User.query.all()
    return render_template("admin.html", users=users, message=message)


@app.route("/admin/reports")
def admin_reports():
    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    year = int(request.args.get("year", current_year()))
    if year < 2000 or year > current_year() + 1:
        year = current_year()
        flash("–ì–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ç–µ–∫—É—â–∏–π", "info")

    students = User.query.filter_by(role="student").all()
    subjects = Subject.query.all()
    if not subjects:
        flash("–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ –±–∞–∑–µ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ë–î.", "danger")
        return redirect(url_for("admin_page"))

    subject_map = {s.id: s.name for s in subjects}
    report_data = []
    for st in students:
        q = Grade.query.filter_by(student_id=st.id, year=year).all()
        subj_avgs = {}
        for g in q:
            subjname = subject_map.get(g.subject_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π")
            subj_avgs.setdefault(subjname, []).append(g.value)
        subj_avgs = {k: round(sum(v)/len(v), 2) if v else 0 for k, v in subj_avgs.items()}
        overall_avg = round(sum([g.value for g in q])/len(q), 2) if q else 0
        report_data.append({
            "student": st.fullname or st.username,
            "subj_avgs": subj_avgs,
            "overall": overall_avg
        })

    return render_template("admin_reports.html",
                           year=year,
                           report_data=report_data,
                           total_students=len(students),
                           subjects=subjects)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin: —ç–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞ –≤ Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/export/admin_xlsx")
def export_admin_xlsx():
    # –ê–¥–º–∏–Ω: —Å–≤–æ–¥–Ω–∞—è –ø–æ —É—á–µ–Ω–∏–∫–∞–º/–ø—Ä–µ–¥–º–µ—Ç–∞–º (—Å—Ä–µ–¥–Ω–∏–µ –∑–∞ –≥–æ–¥)
    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    year = int(request.args.get("year", current_year()))
    students = User.query.filter_by(role="student").all()
    subjects = Subject.query.all()
    subject_map = {s.id: s.name for s in subjects}

    wb = Workbook()
    ws = wb.active
    ws.title = f"–ò—Ç–æ–≥–∏ {year}"

    # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    headers = ["–£—á–µ–Ω–∏–∫"] + [s.name for s in subjects] + ["–û–±—â–∏–π —Å—Ä–µ–¥–Ω–∏–π"]
    ws.append(headers)

    # –î–∞–Ω–Ω—ã–µ
    for st in students:
        q = Grade.query.filter_by(student_id=st.id, year=year).all()
        subj_avgs = {}
        for g in q:
            name = subject_map.get(g.subject_id, "–ù–µ–∏–∑–≤.")
            subj_avgs.setdefault(name, []).append(g.value)

        row = [st.fullname or st.username]
        vals_for_mean = []
        for s in subjects:
            vals = subj_avgs.get(s.name, [])
            avg = round(sum(vals)/len(vals), 2) if vals else ""
            row.append(avg)
            if isinstance(avg, (int, float)):
                vals_for_mean.append(avg)

        overall = round(sum(vals_for_mean)/len(vals_for_mean), 2) if vals_for_mean else ""
        row.append(overall)
        ws.append(row)

    # –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞
    for col in ws.columns:
        max_len = 0
        col_letter = get_column_letter(col[0].column)
        for cell in col:
            max_len = max(max_len, len(str(cell.value)) if cell.value else 0)
        ws.column_dimensions[col_letter].width = max(12, min(40, max_len + 2))

    # –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –æ–±—â–µ–º—É —Å—Ä–µ–¥–Ω–µ–º—É
    last_col = ws.max_column
    data_end = ws.max_row
    if data_end >= 2:
        chart = BarChart()
        chart.title = "–û–±—â–∏–π —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (–ø–æ —É—á–µ–Ω–∏–∫–∞–º)"
        values = Reference(ws, min_col=last_col, min_row=1, max_row=data_end)
        cats = Reference(ws, min_col=1, min_row=2, max_row=data_end)
        chart.add_data(values, titles_from_data=True)
        chart.set_categories(cats)
        chart.y_axis.title = "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"
        chart.x_axis.title = "–£—á–µ–Ω–∏–∫"
        ws.add_chart(chart, f"{get_column_letter(last_col+2)}2")

    filepath = os.path.join(INSTANCE_DIR, f"admin_report_{year}.xlsx")
    wb.save(filepath)
    return send_file(filepath, as_attachment=True)


    
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@app.route("/admin/dashboard")
def admin_dashboard():
    if "user_id" not in session or session.get("role") != "admin":
        flash("–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤", "danger")
        return redirect(url_for("login"))

    return render_template("admin_dashboard.html")


from datetime import datetime

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è Jinja2
@app.template_filter('datetime_format')
def datetime_format(value, format="%d.%m.%Y %H:%M"):
    return value.strftime(format)

@app.context_processor
def utility_processor():
    def current_year():
        return datetime.now().year
    return dict(current_year=current_year)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CLI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if __name__ == "__main__":
    import sys
    with app.app_context():
        db.create_all()
    if "initdb" in sys.argv:
        with app.app_context():
            create_demo_data()
    else:
        app.run(host="0.0.0.0", port=5000, debug=True)
